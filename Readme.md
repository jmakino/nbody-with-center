User's Guide for nbody-with-center

                       2019/11/26 牧野
                       2021/09/10 アップデート

# はじめに

この文章では、 nbody-with-center の最低限の使い方について述べる。FDPS を使った惑星リング系計算のサンプルコードである。あんまりテストしてないのでちゃんとあってるかどうか知らないが、エネルギー保存は(ダンピング入ってるので厳密ではないがそこそこ)する。

# コンパイル方法等

基本的に FDPS の sample/c++/nbody の下にある nbody.cpp と同じだが、

* PS_PATH を適切に (fdps の src があるディレクトリをさすように)設定す
  る
  
* PHANTOM_GRAPE はサポートされない

というあたりが違いである。PHANTOM_GRAPE がなくて遅いので、誰か改良して下さいな

```
 make nbody-with-center :            OpenMP サポート、重心近似
 make nbody-with-center-quad :       OpenMP サポート、4重極近似
 make nbody-with-center-mpi :   OpenMP+MPI サポート、重心近似
 make nbody-with-center-quad-mpi :   OpenMP+MPI サポート、4重極近似
```

の4種類の実行ファイルをつくれる。MPI で高精度にするなら最後のを使うこと。

# 実行

実行時オプションについて説明する

 -i: 入力スナップショットの名前。デフォルトはなしで、この時は
     -N オプションでなにか作られるがリング計算用にはなってない。
     入力ファイルの形式は

     time
     n
     id1 mass1 x1 y1 z1 vx1 vy1 vz1
     ...
     idn massn xn yn zn vxn vyn vzn

である。サンプルファイル ringin を見ること。

 -o: 出力ファイルを置くディレクトリである。デフォルトは ./results である。
     出力はスナップショット毎に別のファイルになる。形式は入力ファイル
     と同じ。

 -e: 衝突時のダンピング係数 eta である。デフォルトは 0

 -p: 重力ソフトニングである。デフォルトは 0
 
 -r: 粒子の物理半径である。デフォルトは0

 -k: 衝突時のバネ定数 kappa である。デフォルトは0

 -t: ツリーの見込み角 theta である。デフォルトは0.5

 -T: シミュレーション終了時刻である。デフォルトは10

 -s: 時間刻みである。デフォルトは 1/512

 -d: ログ出力の時間間隔である。デフォルトは 1/8
 
 -D: スナップショット出力の時間間隔である。デフォルトは 1
 
 -l: ツリーの leaf limit である。デフォルトは 8
 
 -M: 中心星の質量である。デフォルトは 1
 
 -n: ツリーの n_group_limit である。デフォルトは 64
 
 -N: 初期条件を生成する時の粒子数である。デフォルトは 1024。入力ファイ
     ルが指定されていると無視される。

 -K: 粒子同士が衝突した時ににはねかえるまでの時間(振動周期の半分)をタ
     イムステップで表した値。デフォルトは 32 である。この値が正である
     と -k, -e の値に関わらずこれと S オプションから係数が計算される。
 -S: 反発係数。デフォルト 0.5。垂直方向の反発係数である。接線方向は0。

 -R: MPI 並列の時の半径方向の領域分割の数。デフォルトは1である。リング
     の幅とプロセス数を考慮して適切な値を設定すること。
  
  -h: ヘルプメッセージを出力して終了する。


# 初期条件生成

単に動いているかどうかの確認程度だが

 ring.rb

を実行すると、標準出力に、半径 1 から 1.1 の間に、半径方向に20個、角度
方向に 1000 個の粒子を、中心質量が1としてケプラー回転の速度を与えた粒
子を生成する。質量は 5e-8 である。引数に4個パラメータを m n dr massの
順番で与えると (m, n は半径方向及び角度方向) これらのパラメータを変更
できる。

# 実行例

 nbody-with-center-quad  -i ringin -o out -T 0.5 -M 1 -K 128 -s 2e-4 -r 0.004


出力の最後のほうが

```
 time:  0.0000000 energy error: -1.135375e-16
 time:  0.1250010 energy error: -3.603814e-09
 time:  0.2500031 energy error: -4.232810e-09
 time:  0.3750052 energy error: -4.287554e-09
```

で、エネルギー誤差が 1e-8 以下なら問題なく動作している。
    
# 更新履歴

2020/9/10

* FDPS 7.0 に対応して、円筒座標での計算をサポートした。
* オプションを増やし、デフォルトで反発係数が 0.5 になるようにした。
* 富岳用の Makefile Makefile.a64fx を追加した。


